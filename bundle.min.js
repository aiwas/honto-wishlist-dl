String.prototype.toNumber=function(){return Number(this);};async function getWishlist(){const SELECTOR={TOTAL_COUNT:"#mainArea .listInfoTotalCount",COUNT_PER_PAGE:"#mainArea .stSearchBox01 .stRight:last-child select>option:checked",WISHLIST_NAME:"#mainArea .stPullDownList>ul>li.stCurrent>span",BOOK_LINKS:"#mainArea .stBoxLine01 .stHeading>a",TITLE:"#mainArea .stMainArea .stTitle",ISBN:"#mainArea .stLeftArea .stItemData li:last-child"};const getListPageUrl=(id,pageNo)=>{const url=new URL("https://honto.jp/my/wishlist");if(id!=null){url.searchParams.set("wantBookByUseListId",id);}url.searchParams.set("pgno",pageNo.toString());return url.toString();};const getPage=async url=>{const res=await fetch(url);if(res.status!=200){return null;}const dom=new DOMParser().parseFromString(await res.text(),"text/html");return dom;};const sleep=second=>{return new Promise(resolve=>setTimeout(resolve,second*1e3));};const download=(data,fileName)=>{const link=document.createElement("a");link.download=fileName;link.href=URL.createObjectURL(new Blob([data],{type:"text/json"}));document.body.appendChild(link);link.click();URL.revokeObjectURL(link.href);};const wishlistId=new URL(location.href).searchParams.get("wantBookByUseListId");const wishlistName=Array.from(document.querySelector(SELECTOR.WISHLIST_NAME).childNodes).find(x=>x.nodeName==="#text")?.textContent??"【リスト名取得失敗】";const totalCount=document.querySelector(SELECTOR.TOTAL_COUNT)?.innerText?.toNumber()??0;if(totalCount===0){throw new Error;}const countPerPage=document.querySelector(SELECTOR.COUNT_PER_PAGE)?.innerText?.match(/[0-9]+/)?.[0].toNumber()??0;if(countPerPage===0){throw new Error;}const totalPageCount=Math.ceil(totalCount/countPerPage);const result=[];for(let pageNo=1;pageNo<=totalPageCount;pageNo++){const listPage=await getPage(getListPageUrl(wishlistId,pageNo));if(listPage===null){throw new Error;}const bookLinks=Array.from(listPage.querySelectorAll(SELECTOR.BOOK_LINKS)).map(el=>el.href);for(let i=0;i<bookLinks.length;i++){const bookPage=await getPage(bookLinks[i]);if(bookPage==null){continue;}const title=bookPage.querySelector(SELECTOR.TITLE)?.innerText?.trim()??"【タイトル取得失敗】";const isbn=Array.from(bookPage.querySelectorAll(SELECTOR.ISBN)).find(x=>x.innerText.startsWith("ISBN"))?.innerText?.match(/[0-9-]+/)?.[0]?.replaceAll("-","")?.toNumber()??0;console.debug(`[honto-wishlist-dl] (${(pageNo-1)*countPerPage+(i+1)} of ${totalCount}) ${title} / ${isbn}`);result.push({title,isbn});await sleep(2);}await sleep(3);}download(JSON.stringify(result,null,2),`${wishlistId==null?"default":`${wishlistId}_${wishlistName}`}.json`);return result;}export{getWishlist as getWishlist};